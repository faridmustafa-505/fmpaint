<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Göz İzləmə Tətbiqi</title>
    <!-- Tailwind CSS (Dizayn üçün) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- WebGazer.js (Göz izləmə kitabxanası) -->
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Sürüşdürməni bağla */
            background-color: #f3f4f6;
            cursor: crosshair;
        }

        /* Baxış nöqtəsini göstərən qırmızı dairə */
        #gaze-dot {
            position: fixed;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.7);
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none; /* Klikləməyə mane olmasın */
            z-index: 9999;
            transform: translate(-50%, -50%); /* Mərkəzləşdirmək üçün */
            display: none; /* Başlanğıcda gizli */
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: all 0.1s ease-out; /* Yumşaq hərəkət üçün */
        }

        /* Kalibrasiya nöqtələri */
        .calibration-point {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: red;
            border: 3px solid white;
            position: fixed;
            cursor: pointer;
            z-index: 1000;
            display: none; /* Başlanğıcda gizli */
            transition: background-color 0.3s;
        }

        /* Video elementinin yerləşməsi (WebGazer avtomatik yaradır, biz tənzimləyirik) */
        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            width: 240px !important;
            height: auto !important;
            z-index: 50;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #4b5563;
            opacity: 0.8;
        }

        /* Overlay mesajları */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- Baxış nöqtəsi -->
    <div id="gaze-dot"></div>

    <!-- Başlanğıc və Təlimat Ekranı -->
    <div id="overlay">
        <h1 class="text-4xl font-bold mb-4">Göz İzləmə Tətbiqi</h1>
        <p class="mb-6 max-w-lg text-lg text-gray-300">
            Bu tətbiq kameranızdan istifadə edərək ekranda hara baxdığınızı təyin edir.
            Dəqiqlik üçün <span class="text-yellow-400 font-bold">Kalibrasiya</span> vacibdir.
        </p>
        <div class="bg-gray-800 p-4 rounded-lg mb-6 text-left text-sm max-w-md">
            <p class="font-bold text-yellow-500 mb-2">Necə işləyir?</p>
            <ol class="list-decimal pl-5 space-y-1">
                <li>Üzünüzü kameranın mərkəzində saxlayın (işıqlı mühitdə olun).</li>
                <li>"Başla" düyməsinə basın və kamera icazəsi verin.</li>
                <li>Ekranda çıxan 9 nöqtənin hər birinə <strong>baxaraq 5 dəfə klikləyin</strong>.</li>
                <li>Nöqtələr yaşıl olanda kalibrasiya bitmiş sayılır.</li>
            </ol>
        </div>
        <button id="start-btn" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 rounded-full font-bold text-xl transition shadow-lg transform hover:scale-105">
            İzləməni Başlat
        </button>
        <p id="loading-text" class="hidden mt-4 text-yellow-400 animate-pulse">WebGazer yüklənir...</p>
    </div>

    <!-- Kalibrasiya üçün UI paneli (Gizlətmək/Göstərmək üçün) -->
    <div id="controls" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 bg-white p-2 rounded-lg shadow-xl hidden flex gap-2">
        <button id="toggle-video-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm text-black">
            Kameranı Gizlət/Göstər
        </button>
        <button id="restart-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-sm text-white">
            Yenidən Kalibrasiya
        </button>
    </div>

    <!-- Kalibrasiya Nöqtələri (JS ilə yerləşdiriləcək) -->
    <div id="calibration-container"></div>

    <script>
        const gazeDot = document.getElementById('gaze-dot');
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('overlay');
        const loadingText = document.getElementById('loading-text');
        const controls = document.getElementById('controls');
        const calibrationContainer = document.getElementById('calibration-container');
        
        let isCalibrating = false;

        // Kalibrasiya nöqtələrinin koordinatları (faizlə: sol, yuxarı)
        const points = [
            { left: 10, top: 10 }, { left: 50, top: 10 }, { left: 90, top: 10 },
            { left: 10, top: 50 }, { left: 50, top: 50 }, { left: 90, top: 50 },
            { left: 10, top: 90 }, { left: 50, top: 90 }, { left: 90, top: 90 }
        ];

        // WebGazer-i başlatmaq üçün funksiya
        startBtn.addEventListener('click', () => {
            startBtn.classList.add('hidden');
            loadingText.classList.remove('hidden');

            // WebGazer konfiqurasiyası
            webgazer.setRegression('ridge') /* Reqressiya metodu */
                .setGazeListener(function(data, clock) {
                    if (data == null) return;
                    
                    // Kalibrasiya bitibsə nöqtəni hərəkət etdir
                    if (!isCalibrating) {
                        moveGazeDot(data.x, data.y);
                    }
                })
                .saveDataAcrossSessions(true)
                .begin()
                .then(() => {
                    console.log("WebGazer başladı");
                    setupCalibration();
                })
                .catch(e => {
                    alert("Kamera xətası: " + e);
                    location.reload();
                });

            // Video elementini tənzimlə (WebGazer DOM-a əlavə etdikdən sonra)
            setupVideoPreview();
        });

        function setupVideoPreview() {
            // WebGazer video elementini bir az gec yarada bilər
            setTimeout(() => {
                const videoContainer = document.getElementById('webgazerVideoContainer');
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                    // Üz izləmə qutusu rəngini dəyişmək (standart qırmızı olur)
                    webgazer.params.showFaceOverlay = true; 
                    webgazer.params.showFaceFeedbackBox = true;
                }
            }, 1000);
        }

        // Baxış nöqtəsini hərəkət etdirmək (yumşaq hərəkət üçün)
        function moveGazeDot(x, y) {
            // Sadə hamarlama (Smoothness)
            gazeDot.style.display = 'block';
            gazeDot.style.left = x + 'px';
            gazeDot.style.top = y + 'px';
        }

        // Kalibrasiya sistemini qurmaq
        function setupCalibration() {
            loadingText.classList.add('hidden');
            overlay.style.display = 'none'; // Əsas menyunu gizlət
            controls.classList.remove('hidden');
            isCalibrating = true;
            
            // Köhnə nöqtələri təmizlə
            calibrationContainer.innerHTML = '';

            // Nöqtələri yarat
            points.forEach((pos, index) => {
                const dot = document.createElement('div');
                dot.className = 'calibration-point';
                dot.style.left = pos.left + '%';
                dot.style.top = pos.top + '%';
                dot.style.display = 'block';
                dot.dataset.clicks = 0; // Klik sayğacı
                dot.id = `calib-pt-${index}`;
                
                // Klikləmə məntiqi
                dot.addEventListener('click', (e) => {
                    const clicks = parseInt(dot.dataset.clicks) + 1;
                    dot.dataset.clicks = clicks;

                    // WebGazer-ə məlumat göndər: "Mən hazırda bura baxıram"
                    // WebGazer bunu avtomatik edir kliklənəndə, amma əmin olmaq üçün:
                    webgazer.recordScreenPosition(e.clientX, e.clientY, 'click');

                    // Rəng dəyişimi (Vizual geri bildiriş)
                    const opacity = Math.min(clicks / 5, 1);
                    
                    if (clicks < 5) {
                        dot.style.backgroundColor = `rgba(255, 255, 0, ${0.5 + opacity/2})`; // Sarıya doğru
                    } else {
                        dot.style.backgroundColor = '#22c55e'; // Yaşıl (Tamamlandı)
                        dot.style.border = '3px solid #000';
                        checkCalibrationComplete();
                    }
                });

                calibrationContainer.appendChild(dot);
            });
            
            alert("İndi kalibrasiya edəcəyik. Qırmızı nöqtələrin hər birinə baxın və rəngi yaşıl olana qədər (5 dəfə) klikləyin.");
        }

        // Kalibrasiyanın bitib-bitmədiyini yoxla
        function checkCalibrationComplete() {
            const allDots = document.querySelectorAll('.calibration-point');
            let completed = 0;
            allDots.forEach(dot => {
                if (parseInt(dot.dataset.clicks) >= 5) completed++;
            });

            if (completed === points.length) {
                alert("Kalibrasiya tamamlandı! İndi gözlərinizi hərəkət etdirin, qırmızı nöqtə sizi izləyəcək.");
                isCalibrating = false;
                // Nöqtələri gizlət
                allDots.forEach(dot => dot.style.display = 'none');
                // Proqnozu göstər
                webgazer.showPredictionPoints(true); 
            }
        }

        // Kameranı gizlət/göstər düyməsi
        document.getElementById('toggle-video-btn').addEventListener('click', () => {
            const videoContainer = document.getElementById('webgazerVideoContainer');
            if (videoContainer) {
                if (videoContainer.style.display === 'none') {
                    videoContainer.style.display = 'block';
                } else {
                    videoContainer.style.display = 'none';
                }
            }
        });

        // Yenidən başlat düyməsi
        document.getElementById('restart-btn').addEventListener('click', () => {
            webgazer.clearData();
            setupCalibration();
        });

        // Pəncərə bağlananda WebGazer-i dayandır
        window.onbeforeunload = function() {
            webgazer.end();
        };

    </script>
</body>
</html>
