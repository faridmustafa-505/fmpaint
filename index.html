<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Göz İzləyici (Eye Tracker)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- WebGazer.js Kitabxanası -->
    <script src="https://webgazer.cs.brown.edu/webgazer.js" defer></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        /* Kalibrasiya nöqtələri üçün stil */
        .calibration-point {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            background-color: #EF4444; /* Qırmızı */
            opacity: 0.7;
            position: fixed;
            z-index: 50;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        .calibration-point:hover {
            transform: scale(1.5);
            background-color: #3B82F6; /* Mavi */
        }
        
        /* Göz izləmə nöqtəsi (Cursor) */
        #gaze-dot {
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            position: fixed;
            z-index: 40;
            pointer-events: none; /* Klikləməyə mane olmasın */
            display: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            transition: all 0.1s linear;
        }

        /* Video qutusunu yerləşdirmək */
        #webgazerVideoContainer {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            width: 160px !important;
            height: 120px !important;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #4F46E5;
            z-index: 100;
            display: none; /* Başlanğıcda gizli */
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center">

    <!-- İdarəetmə Paneli -->
    <div class="z-50 w-full max-w-4xl p-6 bg-slate-800 rounded-b-xl shadow-2xl border-b border-slate-700">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-indigo-400">Göz İzləyici</h1>
                <p class="text-slate-400 text-sm">Veb-kamera əsaslı izləmə sistemi</p>
            </div>
            
            <div class="flex gap-3">
                <button id="btn-start" onclick="startTracking()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition shadow-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    Kameranı Başlat
                </button>
                <button id="btn-calibrate" onclick="toggleCalibration()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition shadow-lg hidden" disabled>
                    Kalibrasiya Rejimi
                </button>
                <button id="btn-stop" onclick="stopTracking()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition shadow-lg hidden">
                    Dayandır
                </button>
            </div>
        </div>
        
        <!-- Status Mesajı -->
        <div id="status-msg" class="mt-4 text-center text-amber-300 bg-amber-900/30 py-2 rounded border border-amber-700/50">
            Başlamaq üçün "Kameranı Başlat" düyməsini sıxın.
        </div>
    </div>

    <!-- Təlimat -->
    <div id="instructions" class="mt-10 max-w-2xl text-center px-4 transition-opacity duration-500">
        <h2 class="text-xl font-semibold mb-3">Necə işləyir?</h2>
        <ul class="text-slate-300 space-y-2 text-left bg-slate-800 p-6 rounded-xl border border-slate-700">
            <li class="flex items-start gap-2"><span class="text-indigo-400 font-bold">1.</span> Kameraya icazə verin. Üzünüzün kamerada yaşıl çərçivə içində olduğuna əmin olun.</li>
            <li class="flex items-start gap-2"><span class="text-indigo-400 font-bold">2.</span> <span class="text-yellow-400 font-semibold">ÇOX VACİB:</span> Dəqiqlik üçün "Kalibrasiya" düyməsini basın.</li>
            <li class="flex items-start gap-2"><span class="text-indigo-400 font-bold">3.</span> Ekranda görünən 9 qırmızı nöqtənin hər birinə diqqətlə baxın və hər birinə <span class="text-white font-bold">5 dəfə klikləyin</span>.</li>
            <li class="flex items-start gap-2"><span class="text-indigo-400 font-bold">4.</span> Kliklədikcə nöqtələr sarı rəngə dönəcək. Bitdikdən sonra qırmızı kursor gözünüzü izləməyə başlayacaq.</li>
        </ul>
    </div>

    <!-- İzləmə Nöqtəsi -->
    <div id="gaze-dot"></div>

    <!-- Kalibrasiya Konteyneri -->
    <div id="calibration-overlay" class="hidden w-full h-full fixed top-0 left-0 pointer-events-none z-40">
        <!-- Nöqtələr JS ilə yaradılacaq -->
    </div>

    <script>
        let isTracking = false;
        let isCalibrating = false;

        // WebGazer yüklənənə qədər gözləyirik
        window.onload = function() {
            // WebGazer hazır olduqda funksiyaları yükləyə bilərik
            console.log("WebGazer yüklənməyə hazırdır.");
        };

        async function startTracking() {
            try {
                updateStatus("Kamera işə salınır...", "text-blue-400");
                
                // WebGazer-i başladırıq
                await webgazer.setRegression('ridge') /* Sadə reqressiya */
                    .setGazeListener(function(data, clock) {
                        if (data == null) return;
                        
                        // İzləmə nöqtəsini yeniləyirik
                        const gazeDot = document.getElementById('gaze-dot');
                        if (isTracking && !isCalibrating) {
                            gazeDot.style.display = 'block';
                            gazeDot.style.transform = `translate(${data.x}px, ${data.y}px)`;
                        } else {
                            gazeDot.style.display = 'none';
                        }
                    })
                    .saveDataAcrossSessions(true)
                    .begin();

                webgazer.showVideoPreview(true) /* Video görünüşünü aktiv et */
                    .showPredictionPoints(false) /* Varsayılan proqnozu gizlət, biz özümüzünkünü istifadə edirik */
                    .applyKalmanFilter(true); /* Hərəkəti yumşaltmaq üçün */

                // UI Yeniləmələri
                isTracking = true;
                
                // Video konteynerini düzəltmək
                const videoContainer = document.getElementById('webgazerVideoContainer');
                if(videoContainer) {
                    videoContainer.style.display = 'block';
                    videoContainer.style.top = '80px'; // Navbar-dan aşağı
                }

                document.getElementById('btn-start').classList.add('hidden');
                document.getElementById('btn-stop').classList.remove('hidden');
                document.getElementById('btn-calibrate').classList.remove('hidden');
                document.getElementById('btn-calibrate').disabled = false;
                document.getElementById('instructions').style.opacity = '0.5';

                updateStatus("İzləmə aktivdir. Dəqiqlik üçün Kalibrasiya edin!", "text-green-400");
                
                setupCalibrationPoints();

            } catch (err) {
                console.error(err);
                updateStatus("Xəta baş verdi: Kameraya icazə verildiyinə əmin olun.", "text-red-500");
            }
        }

        function stopTracking() {
            webgazer.end();
            isTracking = false;
            
            // Video konteynerini gizlət
            const videoContainer = document.getElementById('webgazerVideoContainer');
            if(videoContainer) videoContainer.style.display = 'none';

            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
            document.getElementById('btn-calibrate').classList.add('hidden');
            document.getElementById('gaze-dot').style.display = 'none';
            document.getElementById('instructions').style.opacity = '1';
            
            toggleCalibration(false); // Kalibrasiyanı söndür əgər açıqdırsa

            updateStatus("İzləmə dayandırıldı.", "text-slate-400");
            // Səhifəni yeniləmək ən təmiz yoldur, kitabxana bəzən qalıqlar buraxır
            setTimeout(() => location.reload(), 1000);
        }

        function updateStatus(text, colorClass) {
            const el = document.getElementById('status-msg');
            el.innerText = text;
            el.className = `mt-4 text-center py-2 rounded border border-slate-700 ${colorClass} bg-slate-800`;
        }

        // --- Kalibrasiya Məntiqi ---

        function setupCalibrationPoints() {
            const overlay = document.getElementById('calibration-overlay');
            overlay.innerHTML = ''; // Təmizlə

            // Ekranın müxtəlif yerlərində 9 nöqtə (Grid)
            const positions = [
                { top: '10%', left: '10%' }, { top: '10%', left: '50%' }, { top: '10%', left: '90%' },
                { top: '50%', left: '10%' }, { top: '50%', left: '50%' }, { top: '50%', left: '90%' },
                { top: '90%', left: '10%' }, { top: '90%', left: '50%' }, { top: '90%', left: '90%' }
            ];

            positions.forEach((pos, index) => {
                const btn = document.createElement('div');
                btn.className = 'calibration-point pointer-events-auto';
                btn.style.top = pos.top;
                btn.style.left = pos.left;
                btn.setAttribute('data-clicks', 0);
                
                // Klikləmə məntiqi
                btn.addEventListener('click', (e) => {
                    let clicks = parseInt(btn.getAttribute('data-clicks')) + 1;
                    btn.setAttribute('data-clicks', clicks);
                    
                    // Görsel geribildirim (hər klikdə biraz böyüyür və rəngi dəyişir)
                    const opacity = Math.min(clicks * 0.2, 1);
                    btn.style.backgroundColor = `rgba(255, 255, 0, ${opacity})`; // Sarıya dönür
                    btn.style.transform = `scale(${1 + (clicks * 0.1)})`;

                    if (clicks >= 5) {
                        btn.style.backgroundColor = '#10B981'; // Yaşıl (tamamlandı)
                        checkCalibrationComplete();
                    }
                });

                overlay.appendChild(btn);
            });
        }

        function toggleCalibration(forceState) {
            const overlay = document.getElementById('calibration-overlay');
            const instructions = document.getElementById('instructions');
            
            if (typeof forceState !== 'undefined') {
                isCalibrating = forceState;
            } else {
                isCalibrating = !isCalibrating;
            }

            if (isCalibrating) {
                overlay.classList.remove('hidden');
                instructions.classList.add('hidden'); // Ekranı təmizlə
                updateStatus("Hər qırmızı nöqtəyə baxın və 5 dəfə klikləyin.", "text-yellow-400");
                // Reset points visually
                setupCalibrationPoints();
            } else {
                overlay.classList.add('hidden');
                instructions.classList.remove('hidden');
                updateStatus("Kalibrasiya bitdi. İndi qırmızı nöqtə gözünüzü izləyəcək.", "text-green-400");
            }
        }

        function checkCalibrationComplete() {
            const points = document.querySelectorAll('.calibration-point');
            let completed = 0;
            points.forEach(p => {
                if (parseInt(p.getAttribute('data-clicks')) >= 5) completed++;
            });

            if (completed === points.length) {
                // Avtomatik bağla
                setTimeout(() => {
                    toggleCalibration(false);
                }, 500);
            }
        }
    </script>
</body>
</html>
