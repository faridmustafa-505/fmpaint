<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Face ID Skaneri</title>
    <!-- MediaPipe Face Mesh Kitabxanaları (Yalnız üz üçün - Daha sürətli) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #000;
            color: #00ffcc;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace; /* Haker/Kod stili */
            margin: 0;
            padding: 0;
            touch-action: none; 
        }

        .canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #001a1a 0%, #000000 100%);
        }

        .input_video { display: none; }

        .output_canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Skaner Xətti Animasiyası */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: #00ffcc;
            box-shadow: 0 0 15px #00ffcc;
            top: 0;
            left: 0;
            animation: scan 3s linear infinite;
            opacity: 0.5;
            pointer-events: none;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { top: 100%; opacity: 0; }
        }

        /* UI Elementləri */
        .hud-top {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        .id-badge {
            background: rgba(0, 20, 20, 0.85);
            border: 1px solid #00ffcc;
            padding: 10px 20px;
            border-radius: 4px;
            display: inline-block;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
            transition: all 0.3s ease;
        }

        .loader {
            border: 3px solid #112222;
            border-top: 3px solid #00ffcc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .corner-bracket {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #00ffcc;
            border-style: solid;
            opacity: 0.6;
            pointer-events: none;
        }
        .tl { top: 20px; left: 20px; border-width: 2px 0 0 2px; }
        .tr { top: 20px; right: 20px; border-width: 2px 2px 0 0; }
        .bl { bottom: 20px; left: 20px; border-width: 0 0 2px 2px; }
        .br { bottom: 20px; right: 20px; border-width: 0 2px 2px 0; }

    </style>
</head>
<body>

    <!-- Yükləmə Ekranı -->
    <div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black">
        <div class="loader mb-4"></div>
        <h2 class="text-lg text-teal-400 font-mono tracking-widest">SYSTEM INITIALIZING...</h2>
    </div>

    <!-- Skaner Xətti -->
    <div class="scan-line"></div>

    <!-- UI Küncləri -->
    <div class="corner-bracket tl"></div>
    <div class="corner-bracket tr"></div>
    <div class="corner-bracket bl"></div>
    <div class="corner-bracket br"></div>

    <!-- Məlumat Paneli -->
    <div class="canvas-container">
        <div class="hud-top">
            <div id="id-display" class="id-badge opacity-0 transform scale-90">
                <div class="text-xs text-teal-500 uppercase tracking-widest mb-1">Identity Detected</div>
                <div id="user-hash" class="text-2xl font-bold text-white tracking-widest font-mono">SCANNING...</div>
            </div>
        </div>

        <video class="input_video" playsinline webkit-playsinline></video>
        <canvas class="output_canvas"></canvas>
    </div>

    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d', { alpha: false });
        const loadingScreen = document.getElementById('loading');
        const idDisplay = document.getElementById('id-display');
        const userHashText = document.getElementById('user-hash');

        // iPhone X və Mobil üçün aşağı keyfiyyət (Amma yüksək FPS)
        const isMobile = true; // Həmişə mobil rejimi aktiv edirik ki, sürətli olsun
        
        // Canvas ölçüləri
        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Unikal Kod Generasiyası (Stabil olması üçün yuvarlaqlaşdırma)
        function generateFaceID(landmarks) {
            // Əsas nöqtələr: 
            // 33: Sol göz daxili, 263: Sağ göz daxili, 1: Burun ucu, 152: Çənə altı
            const p1 = landmarks[33];
            const p2 = landmarks[263];
            const p3 = landmarks[1];
            const p4 = landmarks[152];

            // Məsafələr (Dərinliyi nəzərə almadan sadə Evklid)
            const eyeDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
            const faceLong = Math.hypot(p4.x - p3.x, p4.y - p3.y);
            
            // Nisbət (Ratio) - Kamera yaxınlığına görə dəyişməsin deyə
            const ratio = (faceLong / eyeDist).toFixed(3);
            
            // Sadə "Hash" funksiyası
            let hash = 0;
            const seed = ratio.toString() + "SECRET_SALT";
            for (let i = 0; i < seed.length; i++) {
                const char = seed.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            // Hex-ə çevir və formatla
            const hex = Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
            return `${hex.substring(0, 4)}-${hex.substring(4, 8)}`;
        }

        let lastCode = "SCANNING...";
        let frameCounter = 0;

        function onResults(results) {
            // İlk nəticə gələndə yükləməni gizlət
            if (loadingScreen.style.display !== 'none') {
                loadingScreen.style.display = 'none';
                idDisplay.classList.remove('opacity-0', 'scale-90');
            }

            // Görüntünü çək
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            // Matrix/Sci-fi effekti üçün tünd filter
            canvasCtx.fillStyle = 'rgba(0, 20, 20, 0.4)'; // Tünd yaşıl ton
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                // Toru Çək (Face Mesh)
                // Çox sıx olmaması üçün sadəcə Tesselation
                drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, {color: 'rgba(0, 255, 204, 0.1)', lineWidth: 0.5});
                
                // Gözlər və Üz Çərçivəsi (Daha parlaq)
                drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, {color: '#00ffcc', lineWidth: 2});
                drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, {color: '#00ffcc', lineWidth: 2});
                drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, {color: 'rgba(0, 255, 204, 0.5)', lineWidth: 1});

                // Kodu hesabla (Hər 10 kadrda bir yenilə ki, rəqəmlər titrəməsin)
                if (frameCounter % 15 === 0) {
                    const code = generateFaceID(landmarks);
                    userHashText.innerText = code;
                    userHashText.style.color = "#fff";
                }
                frameCounter++;
                
            } else {
                // Üz yoxdursa
                if (frameCounter % 30 === 0) {
                     userHashText.innerText = "SEARCHING...";
                     userHashText.style.color = "#ff3333";
                }
                frameCounter++;
            }
        }

        const faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});

        faceMesh.setOptions({
            maxNumFaces: 1, // YALNIZ 1 ÜZ - Performans üçün vacibdir
            refineLandmarks: false, // İris (göz bəbəyi) izləməni bağla - Sürət artır
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults(onResults);

        // Kamera Parametrləri - Mobil üçün "VGA" keyfiyyəti (640x480)
        // Bu, Face Mesh üçün kifayətdir və prosessoru qızdırmır
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await faceMesh.send({image: videoElement});
            },
            width: 480,  // Çox aşağı saldım ki, sürət uçsun
            height: 360,
            facingMode: 'user'
        });

        camera.start()
            .then(() => console.log("FaceID sistemi aktivdir"))
            .catch(err => {
                alert("Kamera xətası: " + err);
            });

    </script>
</body>
</html>
